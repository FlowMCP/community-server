name: Test

on:
  release:
    types: [published]
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [22.x]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Create test environment file
      run: |
        echo "# Test Environment Variables for CI/CD" > .community.env
        echo "SERVER_URL=http://localhost" >> .community.env
        echo "SERVER_PORT=8080" >> .community.env
        echo "WEBHOOK_SECRET=test-webhook-secret-123" >> .community.env
        echo "WEBHOOK_PORT=3001" >> .community.env
        echo "PM2_NAME=test-community-server" >> .community.env
        echo "BEARER_TOKEN_EERC20=test-eerc20-token" >> .community.env
        echo "BEARER_TOKEN_INSEIGHT=test-inseight-token" >> .community.env
        echo "AUTH0_DOMAIN=test-domain.auth0.com" >> .community.env
        echo "AUTH0_CLIENT_ID=test-auth0-client-id" >> .community.env
        echo "ACCOUNT_DEVELOPMENT2_PRIVATE_KEY=0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef12" >> .community.env
        echo "ACCOUNT_DEVELOPMENT2_PUBLIC_KEY=0x742d35Cc6634C0532925a3b8D6aC6782d3B5C123" >> .community.env
        echo "BASE_SEPOLIA_ALCHEMY_HTTP=https://base-sepolia.g.alchemy.com/v2/test-api-key-12345" >> .community.env
        echo "TEST_VARIABLE=test-value" >> .community.env
        echo "ANOTHER_TEST=another-value" >> .community.env
    
    - name: Run tests with coverage
      run: npm run test:coverage:src
      env:
        NODE_OPTIONS: '--experimental-vm-modules'
    
    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false