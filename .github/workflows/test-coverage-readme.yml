name: Run Tests with Coverage and Update README

on:
  push:
    branches:
      - main
# optional sinnvoll: auch PRs pr√ºfen
# on:
#   push:
#   pull_request:

permissions:
  contents: write
  id-token: write   # << n√∂tig f√ºr OIDC

jobs:
  test-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Create test environment file
        run: |
          echo "# Test Environment Variables for ServerManager Tests" > tests/.test.env
          echo "WEBHOOK_SECRET=test-webhook-secret-123" >> tests/.test.env
          echo "WEBHOOK_PORT=3007" >> tests/.test.env
          echo "PM2_NAME=test-community-server" >> tests/.test.env
          echo "BEARER_TOKEN__0=test-avalanche-token" >> tests/.test.env
          echo "BEARER_TOKEN__1=test-agentpays-token" >> tests/.test.env
          echo "BEARER_TOKEN__2=test-lukso-token" >> tests/.test.env
          echo "BEARER_TOKEN__3=test-chainlink-token" >> tests/.test.env
          echo "ACCOUNT_DEVELOPMENT2_PRIVATE_KEY=0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef12" >> tests/.test.env
          echo "ACCOUNT_DEVELOPMENT2_PUBLIC_KEY=0x742d35Cc6634C0532925a3b8D6aC6782d3B5C123" >> tests/.test.env
          echo "BASE_SEPOLIA_ALCHEMY_HTTP=https://base-sepolia.g.alchemy.com/v2/test-api-key-12345" >> tests/.test.env

      - name: Create development test environment file
        run: |
          echo "# Development Test Environment" > tests/.community.env
          echo "SERVER_URL=http://localhost" >> tests/.community.env
          echo "SERVER_PORT=3000" >> tests/.community.env
          echo "WEBHOOK_SECRET=dev_webhook_secret_123" >> tests/.community.env
          echo "WEBHOOK_PORT=3001" >> tests/.community.env
          echo "PM2_NAME=community-server-dev" >> tests/.community.env

      - name: Run Jest tests (with coverage)
        run: npm run test:coverage:src
        env:
          NODE_OPTIONS: '--experimental-vm-modules'

      - name: Upload coverage to Codecov (OIDC)
        uses: codecov/codecov-action@v5
        with:
          use_oidc: true
          files: ./coverage/lcov.info      # Jest legt diese Datei standardm√§√üig an
          fail_ci_if_error: true
          flags: unittests
        # optional: auch hochladen, wenn Tests fehlschlagen
        # if: ${{ always() }}

      - name: Generate README
        run: node ./.github/workflows/generate-readme/index.mjs

      - name: Commit and Push README Changes
        env:
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config user.email "${{ secrets.USER_EMAIL }}"
          git config user.name "a6b8"
          git add .
          if ! git diff --cached --exit-code; then
            git commit -m "Update README with latest schema changes ü§ñ"
            git push
          else
            echo "No README changes to commit"
          fi